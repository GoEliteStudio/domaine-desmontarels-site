---
/**
 * Root Redirect Engine - The "Traffic Cop"
 * 
 * Handles all traffic to the root URL (https://villa-*.vercel.app/)
 * Intelligently redirects to the correct villa + language:
 * 
 * 1. Detects which villa site (hostname → slug mapping)
 * 2. Detects user's preferred language (Accept-Language header)
 * 3. Redirects to /villas/{slug}/{lang}/
 * 
 * This is a SERVER-SIDE ONLY page (no static pre-rendering)
 * Must read request headers to detect language preference
 */

// Must be server-side rendered to read headers
export const prerender = false;

import { VILLA_LANGUAGES, DEFAULT_LANG, HOSTNAME_SLUG_MAP, DEFAULT_VILLA_SLUG } from '../config/i18n';

// Step 1: Identify which villa site this is
// Priority: hostname mapping → env var → default
const hostname = Astro.request.headers.get('host') || '';
const envSlug = import.meta.env.VILLA_SLUG as string | undefined;
const currentSlug = HOSTNAME_SLUG_MAP[hostname] || envSlug || DEFAULT_VILLA_SLUG;

// Step 2: Get supported languages for this villa
const supportedLangs = VILLA_LANGUAGES[currentSlug] || [DEFAULT_LANG];

// Step 3: Detect browser's preferred language
// Header format: "es-ES,es;q=0.9,en-US;q=0.8,en;q=0.7"
// Extract first language code (es-ES → es)
const acceptHeader = Astro.request.headers.get('accept-language') || '';
const preferredLang = acceptHeader.split(',')[0]?.split('-')[0]?.toLowerCase() || DEFAULT_LANG;

// Step 4: Choose target language
// If user's preferred language is supported → use it
// Otherwise → fallback to default language
let targetLang = DEFAULT_LANG;

if (supportedLangs.includes(preferredLang)) {
  targetLang = preferredLang;
}

// Step 5: Execute permanent redirect (301)
// SEO-friendly: tells Google this is the canonical location
// Preserves PageRank from root to language-specific page
const targetUrl = `/villas/${currentSlug}/${targetLang}/`;

return Astro.redirect(targetUrl, 301);
---
