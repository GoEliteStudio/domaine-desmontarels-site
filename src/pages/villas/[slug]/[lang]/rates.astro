---
import BaseLayout from '../../../../layouts/BaseLayout.astro';
import { VILLA_LANGUAGES, getVillaBySlug } from '../../../../config/i18n';
import { getUIStrings } from '../../../../config/uiStrings';
import { buildAuxPageSchema } from '../../../../lib/schema';

export const prerender = true;

export async function getStaticPaths() {
  const paths = [];
  for (const [slug, languages] of Object.entries(VILLA_LANGUAGES)) {
    for (const lang of languages) {
      paths.push({ params: { slug, lang } });
    }
  }
  return paths;
}

const { slug, lang } = Astro.params;

// Load villa data for the specific language
let villa;
try {
  const villaModule = await import(`../../../../content/villas/${slug}.${lang}.json`);
  villa = villaModule.default;
} catch {
  const villaModule = await import(`../../../../content/villas/${slug}.en.json`);
  villa = villaModule.default;
}

// Get UI strings for this language
const ui = getUIStrings(lang);
const ratesUI = ui.rates;

// Villa-specific paths
const villaBasePath = `/villas/${slug}`;
const langBasePath = `${villaBasePath}/${lang}`;

// Header navigation
const navLinks = ui.header.navigation.map((link: { label: string; href: string }) => ({
  ...link,
  href: link.href.startsWith('#') ? `${langBasePath}/${link.href}` : link.href
}));
const navCtaLabel = ui.header.inquireCta;

// Villa-specific footer with localized links
const villaFooter = {
  ...ui.footer,
  brandDescription: villa.summary,
  exploreLinks: ui.footer.exploreLinks.map((link: { label: string; href: string }) => {
    // Point explore links to main villa page sections
    if (link.href.startsWith('#')) return { ...link, href: `${langBasePath}/${link.href}` };
    return link;
  }),
  infoLinks: ui.footer.infoLinks.map((link: { label: string; href: string }) => {
    if (link.href === '/rates') return { ...link, href: `${langBasePath}/rates` };
    if (link.href === '/terms') return { ...link, href: `${langBasePath}/terms` };
    if (link.href === '/privacy') return { ...link, href: `${langBasePath}/privacy` };
    return link;
  }),
  contactLinks: ui.footer.contactLinks.map((link: { label: string; href: string }) => {
    if (link.href === '/contact') return { ...link, href: `${langBasePath}/contact` };
    return link;
  })
};

const title = `${ratesUI.pageTitle} â€” ${villa.name}`;
const description = ratesUI.intro.replace('{villaName}', villa.name);

// Build schema for SEO
const villaConfig = getVillaBySlug(slug);
const siteBase = villaConfig?.domain ? `https://${villaConfig.domain}` : Astro.url.origin;
const canonical = `${siteBase}/villas/${slug}/${lang}/rates`;
const localeMap: Record<string, string> = { en: 'en-US', es: 'es-ES', fr: 'fr-FR' };

const jsonLd = buildAuxPageSchema({
  pageType: 'rates',
  pageTitle: title,
  pageDescription: description,
  canonical,
  siteBase,
  villaName: villa.name,
  slug,
  lang,
  locale: localeMap[lang] || 'en-US'
});
---
<BaseLayout 
  title={title} 
  description={description} 
  canonical={canonical}
  villaName={villa.name}
  homeUrl={langBasePath}
  navLinks={navLinks}
  navCtaLabel={navCtaLabel}
  navCtaHref={`${langBasePath}/contact`}
  footer={villaFooter}
  lang={lang}
  jsonLd={jsonLd}
>
  <section class="container policy" id="rates">
    <h1>{ratesUI.pageTitle}</h1>
    <p class="intro">{ratesUI.intro.replace('{villaName}', villa.name)}</p>

    <div class="section">
      <h2>{ratesUI.seasonalPricing}</h2>
      <p>{ratesUI.seasonalPricingIntro}</p>
      <div class="seasons-grid">
        <div class="season-card">
          <h3>{ratesUI.highSeason}</h3>
          <p class="season-dates">{ratesUI.highSeasonDates}</p>
          <p>{ratesUI.highSeasonDesc}</p>
        </div>
        <div class="season-card">
          <h3>{ratesUI.midSeason}</h3>
          <p class="season-dates">{ratesUI.midSeasonDates}</p>
          <p>{ratesUI.midSeasonDesc}</p>
        </div>
        <div class="season-card">
          <h3>{ratesUI.lowSeason}</h3>
          <p class="season-dates">{ratesUI.lowSeasonDates}</p>
          <p>{ratesUI.lowSeasonDesc}</p>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>{ratesUI.whatsIncluded}</h2>
      <ul>
        {ratesUI.includedItems.map((item: string) => <li>{item}</li>)}
      </ul>
    </div>

    <div class="section">
      <h2>{ratesUI.additionalServices}</h2>
      <p>{ratesUI.additionalServicesIntro}</p>
      <ul>
        {ratesUI.additionalItems.map((item: string) => <li>{item}</li>)}
      </ul>
    </div>

    <div class="section cta-section">
      <h2>{ratesUI.ctaHeading}</h2>
      <p>{ratesUI.ctaText}</p>
      <a href={`${langBasePath}/contact`} class="cta-button">{ratesUI.ctaButton}</a>
    </div>
  </section>
  
  <style>
    .policy {
      max-width: 800px;
      margin: 120px auto;
      padding: 0 1.5rem;
      box-sizing: border-box;
      font-family: var(--font-sans, system-ui, sans-serif);
      font-size: 1.05rem;
      line-height: 1.8;
      color: #333;
    }
    .policy h1 {
      font-family: var(--font-serif, serif);
      font-size: 2.8rem;
      font-weight: 500;
      color: var(--color-black, #111);
      margin-bottom: 1rem;
      line-height: 1.2;
    }
    .policy .intro {
      font-size: 1.15rem;
      color: #555;
      margin-bottom: 2.5rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid #eee;
    }
    .policy .section {
      margin-bottom: 2.5rem;
    }
    .policy h2 {
      font-family: var(--font-serif, serif);
      font-size: 1.5rem;
      font-weight: 500;
      color: var(--color-black, #111);
      margin-bottom: 1rem;
    }
    .policy p {
      margin-bottom: 1rem;
    }
    .policy ul {
      padding-left: 0;
      list-style: none;
      margin-bottom: 1rem;
    }
    .policy li {
      margin-bottom: 0.75rem;
      padding-left: 1.25rem;
      position: relative;
    }
    .policy li::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0.6em;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--color-accent, #a58e76);
    }
    
    .seasons-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.5rem;
      margin-top: 1.5rem;
    }
    .season-card {
      background: linear-gradient(180deg, #fafafa 0%, #f5f3f0 100%);
      border: 1px solid rgba(165, 142, 118, 0.15);
      border-radius: 12px;
      padding: 1.5rem;
    }
    .season-card h3 {
      font-family: var(--font-serif, serif);
      font-size: 1.2rem;
      font-weight: 500;
      color: var(--color-black, #111);
      margin: 0 0 0.5rem;
    }
    .season-dates {
      font-size: 0.85rem;
      color: var(--color-accent, #a58e76);
      font-weight: 500;
      margin-bottom: 0.75rem !important;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .season-card p:last-child {
      margin-bottom: 0;
      font-size: 0.95rem;
      color: #666;
    }
    
    .cta-section {
      background: linear-gradient(180deg, #fafafa 0%, #f5f3f0 100%);
      border: 1px solid rgba(165, 142, 118, 0.15);
      border-radius: 12px;
      padding: 2rem;
      text-align: center;
      margin-top: 3rem;
    }
    .cta-section h2 {
      margin-bottom: 0.75rem;
    }
    .cta-section p {
      max-width: 500px;
      margin: 0 auto 1.5rem;
    }
    .cta-button {
      display: inline-block;
      background: var(--color-black, #111);
      color: #fff;
      padding: 14px 32px;
      border-radius: 4px;
      text-decoration: none;
      font-weight: 500;
      font-size: 0.9rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      transition: background 0.3s ease;
    }
    .cta-button:hover {
      background: var(--color-accent, #a58e76);
    }
    
    @media (max-width: 768px) {
      .policy {
        margin: 80px auto;
        font-size: 1rem;
      }
      .policy h1 {
        font-size: 2.2rem;
      }
      .policy h2 {
        font-size: 1.3rem;
      }
      .seasons-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</BaseLayout>
